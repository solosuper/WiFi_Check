#!/usr/bin/env bash

# The IP for the server to ping
SERVER=192.168.100.1

INTERFACE="wlan0"

LOCKFILE="/var/run/$(basename $0).pid"
TAG="wifi-check"

logger -t $TAG "$(date) routine check for $INTERFACE"

### Handle lockfile ###
if [ -e ${LOCKFILE} ]; then
  PID=$(<${LOCKFILE})
  if kill -0 &>1 > /dev/null $PID; then
    logger -t $TAG "$PID still running"
    exit 1
  else
    rm ${LOCKFILE}
  fi
fi

echo $$ > ${LOCKFILE}

### Check status by ping
ping -c2 ${SERVER} > /dev/null
if [ $? != 0 ]; then
  logger -t $TAG "ping ${SERVER} failed - run ifup on ${INTERFACE}"
  ifdown --force ${INTERFACE}
  sleep 5
  ifup ${INTERFACE}
fi

### Check status by ifconfig
# if ifconfig $wlan | grep -q "inet addr:" ; then
#     # Network is Okay
# else
#   logger -t $TAG "ping ${SERVER} failed - run ifup on ${INTERFACE}"
#   ifdown --force ${INTERFACE}
#   sleep 5
#   ifup ${INTERFACE}
# fi

### Exit
rm ${LOCKFILE}
exit 0

# end
